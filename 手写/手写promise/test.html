<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <script>
      function myPromise(executor) {
        this.value = "";
        this.status = "pending";
        this.resloveBox = [];
        this.rejectBox = [];
        var that = this;
        function reslove(value) {
          that.value = value;
          if (that.status === "pending") {
            that.status = "fulfilled";
            that.resloveBox.forEach((val) => {
              val();
            });
          }
        }

        function reject(value) {
          that.value = value;
          if (that.status === "pending") {
            that.status = "rejected";
            that.rejectBox.forEach((val) => {
              val();
            });
          }
        }
        executor(reslove, reject);
      }
      myPromise.prototype.dealPromise = function (
        nextPromise,
        result,
        resolve,
        reject
      ) {
        try {
          if (
            Object.prototype.toString.call(result) === "[object Object]" &&
            typeof result.then == "function"
          ) {
            result.then.call(
              result,
              (val) => {
                this.dealPromise(result, val, resolve, reject);
              },
              (err) => {
                reject(err);
              }
            );
          } else {
            resolve(result);
          }
        } catch (error) {
          reject(error);
        }
      };
      myPromise.prototype.then = function (onFulfilled, onRejected) {
        onFulfilled =
          typeof onFulfilled === "function" ? onFulfilled : (value) => value;
        onRejected =
          typeof onRejected === "function"
            ? onRejected
            : (err) => {
                throw err;
              };
        var nextPromise = new myPromise((resolve, reject) => {
          if (this.status === "fulfilled") {
            var result = onFulfilled(this.value);
            this.dealPromise(nextPromise, result, resolve, reject);
          }
          if (this.status === "rejected") {
            var result = onRejected(this.value);
            this.dealPromise(nextPromise, result, resolve, reject);
          }
          if (this.status === "pending") {
            this.resloveBox.push(() => {
              var result = onFulfilled(this.value);
              this.dealPromise(nextPromise, result, resolve, reject, );
            });
            this.rejectBox.push(() => {
              try {
                var result = onRejected(this.value);
              } catch (error) {
                reject(this.value)
              }
              this.dealPromise(nextPromise, result, resolve, reject);
            });
          }
        });
        return nextPromise;
      };

      // var a = new myPromise((reslove, reject) => {
      //   setTimeout((_) => {
      //     reslove(2);
      //   }, 1000);
      // });
      // a.then(function (val) {
      //   console.log(val);
      //   return 1;
      // })
      //   .then(function (val) {
      //     console.log(val);
      //     return "嘿嘿";
      //   })
      //   .then(function (val) {
      //     console.log(val);
      //     return new myPromise((reslove, reject) => {
      //       setTimeout((_) => {
      //         reject("这是第二个promise");
      //       }, 1000);
      //     });
      //   })
      //   .then(
      //     (val) => {
      //       console.log(val, 111);
      //     },
      //     (err) => {
      //       console.log("报错了");
      //     }
      //   );
      var a = new myPromise((reslove, reject) => {
        setTimeout((_) => {
          reject(2);
        }, 1000);
      })
        .then(() => {
          return 1
        })
        .then(
          () => {},
          (err) => {
            console.log(err);
          }
        );
    </script>
  </body>
</html>
