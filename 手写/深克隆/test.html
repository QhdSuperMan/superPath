<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      function deepCopy(obj, cache = new WeakMap()) {
        let typeBox = [
          "[object Array]",
          "[object Object]",
          "[object Map]",
          "[object Set]",
        ];
        let type = Object.prototype.toString.call(obj);
        if (!typeBox.includes(type)) return obj
        if (cache.get(obj)) return cache.get(obj)

        let copyObj = new obj.constructor()
        cache.set(obj, copyObj)

        if (type === "[object Map]") {
            obj.forEach((val, key) => {
                copyObj.set(deepCopy(key, cache), deepCopy(val, cache))
            });
            return copyObj

        }

        if (type === "[object Set]") {
            obj.forEach((val, key) => {
                copyObj.add(key, deepCopy(val, cache))
            });
            return copyObj

        }

        for(let key in obj) {
            if(obj.hasOwnProperty(key)) {
                copyObj[key] = deepCopy(obj[key], cache)
            }
        }

        return copyObj
      }

      var mapKey = {
        key: 1,
      };
      var mapValue = {
        value: 1,
      };
      var map = new Map();
      map.set(mapKey, mapValue);
      var set = new Set([1, 2, 3]);
      // 测试
      const obj = {
        name: "Jack",
        id: new Date(),
        map: map,
        set: set,
        address: {
          s: {
            k: 1,
          },
          x: 100,
          y: 200,
        },
      };
      obj.a = obj; // 循环引用
      const newObj = deepCopy(obj);
      console.log(newObj); // false
    </script>
  </body>
</html>
